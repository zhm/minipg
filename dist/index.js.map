{"version":3,"file":"index.js","names":["_cursor","_interopRequireDefault","require","e","__esModule","_typeof","o","Symbol","iterator","constructor","prototype","_classCallCheck","a","n","TypeError","_defineProperties","r","t","length","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","i","_toPrimitive","toPrimitive","call","String","Number","NativeClient","Client","genericPool","defaultNoticeProcessor","message","console","warn","nextClientID","exports","nativeClient","id","value","connect","string","callback","_this","err","setNoticeProcessor","query","sql","finished","Error","Cursor","getResult","returnMetadata","_this2","setImmediate","getResults","_this3","close","processor","get","error","lastError","queryError","prop","hasOwnProperty","createPool","options","Pool","name","create","db","client","destroy","max","idleTimeoutMillis","reapIntervalMillis","log"],"sources":["../src/index.js"],"sourcesContent":["const NativeClient = require('bindings')('addon').Client;\nconst genericPool = require('generic-pool');\n\nimport Cursor from './cursor';\n\nfunction defaultNoticeProcessor(message) {\n  console.warn(message);\n}\n\nlet nextClientID = 0;\n\nexport class Client {\n  constructor() {\n    this.nativeClient = new NativeClient();\n    this.id = ++nextClientID;\n  }\n\n  connect(string, callback) {\n    this.nativeClient.connect(string, (err) => {\n      if (err) {\n        return callback(err, this);\n      }\n\n      this.nativeClient.setNoticeProcessor(Client.defaultNoticeProcessor || defaultNoticeProcessor);\n\n      return callback(null, this);\n    });\n  }\n\n  query(sql) {\n    if (!this.nativeClient.finished()) {\n      throw new Error('client in use', this.id);\n    }\n\n    this.nativeClient.query(sql);\n\n    return new Cursor(this);\n  }\n\n  // fetch a single result record\n  getResult(returnMetadata, callback) {\n    Client.setImmediate(() => {\n      callback(this.nativeClient.getResult(returnMetadata));\n    });\n  }\n\n  getResults(returnMetadata, callback) {\n    Client.setImmediate(() => {\n      callback(this.nativeClient.getResults(returnMetadata));\n    });\n  }\n\n  close() {\n    return this.nativeClient.close();\n  }\n\n  setNoticeProcessor(processor) {\n    this.nativeClient.setNoticeProcessor(processor);\n  }\n\n  get lastError() {\n    const error = this.nativeClient.lastError();\n\n    if (error == null) {\n      return null;\n    }\n\n    const queryError = new Error();\n\n    for (const prop in error) {\n      if (error.hasOwnProperty(prop)) {\n        queryError[prop] = error[prop];\n      }\n    }\n\n    return queryError;\n  }\n}\n\nClient.setImmediate = setImmediate;\nClient.defaultNoticeProcessor = defaultNoticeProcessor;\n\nexport function createPool(options) {\n  /* eslint-disable new-cap */\n  return genericPool.Pool({\n    name: options.name || 'minipg',\n    create: (callback) => {\n      new Client().connect(options.db, (err, client) => {\n        if (err) {\n          return callback(client ? (client.lastError || err) : err);\n        }\n\n        return callback(null, client);\n      });\n    },\n    destroy: (client) => {\n      if (client) {\n        client.close();\n      }\n    },\n    max: options.max || 10,\n    idleTimeoutMillis: options.idleTimeoutMillis || 30000,\n    reapIntervalMillis: options.reapIntervalMillis || 1000,\n    log: options.log\n  });\n  /* eslint-enable new-cap */\n}\n"],"mappings":";;;;;;;AAGA,IAAAA,OAAA,GAAAC,sBAAA,CAAAC,OAAA;AAA8B,SAAAD,uBAAAE,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,gBAAAA,CAAA;AAAA,SAAAE,QAAAC,CAAA,sCAAAD,OAAA,wBAAAE,MAAA,uBAAAA,MAAA,CAAAC,QAAA,aAAAF,CAAA,kBAAAA,CAAA,gBAAAA,CAAA,WAAAA,CAAA,yBAAAC,MAAA,IAAAD,CAAA,CAAAG,WAAA,KAAAF,MAAA,IAAAD,CAAA,KAAAC,MAAA,CAAAG,SAAA,qBAAAJ,CAAA,KAAAD,OAAA,CAAAC,CAAA;AAAA,SAAAK,gBAAAC,CAAA,EAAAC,CAAA,UAAAD,CAAA,YAAAC,CAAA,aAAAC,SAAA;AAAA,SAAAC,kBAAAZ,CAAA,EAAAa,CAAA,aAAAC,CAAA,MAAAA,CAAA,GAAAD,CAAA,CAAAE,MAAA,EAAAD,CAAA,UAAAX,CAAA,GAAAU,CAAA,CAAAC,CAAA,GAAAX,CAAA,CAAAa,UAAA,GAAAb,CAAA,CAAAa,UAAA,QAAAb,CAAA,CAAAc,YAAA,kBAAAd,CAAA,KAAAA,CAAA,CAAAe,QAAA,QAAAC,MAAA,CAAAC,cAAA,CAAApB,CAAA,EAAAqB,cAAA,CAAAlB,CAAA,CAAAmB,GAAA,GAAAnB,CAAA;AAAA,SAAAoB,aAAAvB,CAAA,EAAAa,CAAA,EAAAC,CAAA,WAAAD,CAAA,IAAAD,iBAAA,CAAAZ,CAAA,CAAAO,SAAA,EAAAM,CAAA,GAAAC,CAAA,IAAAF,iBAAA,CAAAZ,CAAA,EAAAc,CAAA,GAAAK,MAAA,CAAAC,cAAA,CAAApB,CAAA,iBAAAkB,QAAA,SAAAlB,CAAA;AAAA,SAAAqB,eAAAP,CAAA,QAAAU,CAAA,GAAAC,YAAA,CAAAX,CAAA,gCAAAZ,OAAA,CAAAsB,CAAA,IAAAA,CAAA,GAAAA,CAAA;AAAA,SAAAC,aAAAX,CAAA,EAAAD,CAAA,oBAAAX,OAAA,CAAAY,CAAA,MAAAA,CAAA,SAAAA,CAAA,MAAAd,CAAA,GAAAc,CAAA,CAAAV,MAAA,CAAAsB,WAAA,kBAAA1B,CAAA,QAAAwB,CAAA,GAAAxB,CAAA,CAAA2B,IAAA,CAAAb,CAAA,EAAAD,CAAA,gCAAAX,OAAA,CAAAsB,CAAA,UAAAA,CAAA,YAAAb,SAAA,yEAAAE,CAAA,GAAAe,MAAA,GAAAC,MAAA,EAAAf,CAAA;AAH9B,IAAMgB,YAAY,GAAG/B,OAAO,CAAC,UAAU,CAAC,CAAC,OAAO,CAAC,CAACgC,MAAM;AACxD,IAAMC,WAAW,GAAGjC,OAAO,CAAC,cAAc,CAAC;AAI3C,SAASkC,sBAAsBA,CAACC,OAAO,EAAE;EACvCC,OAAO,CAACC,IAAI,CAACF,OAAO,CAAC;AACvB;AAEA,IAAIG,YAAY,GAAG,CAAC;AAAC,IAERN,MAAM,GAAAO,OAAA,CAAAP,MAAA;EACjB,SAAAA,OAAA,EAAc;IAAAvB,eAAA,OAAAuB,MAAA;IACZ,IAAI,CAACQ,YAAY,GAAG,IAAIT,YAAY,CAAC,CAAC;IACtC,IAAI,CAACU,EAAE,GAAG,EAAEH,YAAY;EAC1B;EAAC,OAAAd,YAAA,CAAAQ,MAAA;IAAAT,GAAA;IAAAmB,KAAA,EAED,SAAAC,OAAOA,CAACC,MAAM,EAAEC,QAAQ,EAAE;MAAA,IAAAC,KAAA;MACxB,IAAI,CAACN,YAAY,CAACG,OAAO,CAACC,MAAM,EAAE,UAACG,GAAG,EAAK;QACzC,IAAIA,GAAG,EAAE;UACP,OAAOF,QAAQ,CAACE,GAAG,EAAED,KAAI,CAAC;QAC5B;QAEAA,KAAI,CAACN,YAAY,CAACQ,kBAAkB,CAAChB,MAAM,CAACE,sBAAsB,IAAIA,sBAAsB,CAAC;QAE7F,OAAOW,QAAQ,CAAC,IAAI,EAAEC,KAAI,CAAC;MAC7B,CAAC,CAAC;IACJ;EAAC;IAAAvB,GAAA;IAAAmB,KAAA,EAED,SAAAO,KAAKA,CAACC,GAAG,EAAE;MACT,IAAI,CAAC,IAAI,CAACV,YAAY,CAACW,QAAQ,CAAC,CAAC,EAAE;QACjC,MAAM,IAAIC,KAAK,CAAC,eAAe,EAAE,IAAI,CAACX,EAAE,CAAC;MAC3C;MAEA,IAAI,CAACD,YAAY,CAACS,KAAK,CAACC,GAAG,CAAC;MAE5B,OAAO,IAAIG,kBAAM,CAAC,IAAI,CAAC;IACzB;;IAEA;EAAA;IAAA9B,GAAA;IAAAmB,KAAA,EACA,SAAAY,SAASA,CAACC,cAAc,EAAEV,QAAQ,EAAE;MAAA,IAAAW,MAAA;MAClCxB,MAAM,CAACyB,YAAY,CAAC,YAAM;QACxBZ,QAAQ,CAACW,MAAI,CAAChB,YAAY,CAACc,SAAS,CAACC,cAAc,CAAC,CAAC;MACvD,CAAC,CAAC;IACJ;EAAC;IAAAhC,GAAA;IAAAmB,KAAA,EAED,SAAAgB,UAAUA,CAACH,cAAc,EAAEV,QAAQ,EAAE;MAAA,IAAAc,MAAA;MACnC3B,MAAM,CAACyB,YAAY,CAAC,YAAM;QACxBZ,QAAQ,CAACc,MAAI,CAACnB,YAAY,CAACkB,UAAU,CAACH,cAAc,CAAC,CAAC;MACxD,CAAC,CAAC;IACJ;EAAC;IAAAhC,GAAA;IAAAmB,KAAA,EAED,SAAAkB,KAAKA,CAAA,EAAG;MACN,OAAO,IAAI,CAACpB,YAAY,CAACoB,KAAK,CAAC,CAAC;IAClC;EAAC;IAAArC,GAAA;IAAAmB,KAAA,EAED,SAAAM,kBAAkBA,CAACa,SAAS,EAAE;MAC5B,IAAI,CAACrB,YAAY,CAACQ,kBAAkB,CAACa,SAAS,CAAC;IACjD;EAAC;IAAAtC,GAAA;IAAAuC,GAAA,EAED,SAAAA,IAAA,EAAgB;MACd,IAAMC,KAAK,GAAG,IAAI,CAACvB,YAAY,CAACwB,SAAS,CAAC,CAAC;MAE3C,IAAID,KAAK,IAAI,IAAI,EAAE;QACjB,OAAO,IAAI;MACb;MAEA,IAAME,UAAU,GAAG,IAAIb,KAAK,CAAC,CAAC;MAE9B,KAAK,IAAMc,IAAI,IAAIH,KAAK,EAAE;QACxB,IAAIA,KAAK,CAACI,cAAc,CAACD,IAAI,CAAC,EAAE;UAC9BD,UAAU,CAACC,IAAI,CAAC,GAAGH,KAAK,CAACG,IAAI,CAAC;QAChC;MACF;MAEA,OAAOD,UAAU;IACnB;EAAC;AAAA;AAGHjC,MAAM,CAACyB,YAAY,GAAGA,YAAY;AAClCzB,MAAM,CAACE,sBAAsB,GAAGA,sBAAsB;AAE/C,SAASkC,UAAUA,CAACC,OAAO,EAAE;EAClC;EACA,OAAOpC,WAAW,CAACqC,IAAI,CAAC;IACtBC,IAAI,EAAEF,OAAO,CAACE,IAAI,IAAI,QAAQ;IAC9BC,MAAM,EAAE,SAARA,MAAMA,CAAG3B,QAAQ,EAAK;MACpB,IAAIb,MAAM,CAAC,CAAC,CAACW,OAAO,CAAC0B,OAAO,CAACI,EAAE,EAAE,UAAC1B,GAAG,EAAE2B,MAAM,EAAK;QAChD,IAAI3B,GAAG,EAAE;UACP,OAAOF,QAAQ,CAAC6B,MAAM,GAAIA,MAAM,CAACV,SAAS,IAAIjB,GAAG,GAAIA,GAAG,CAAC;QAC3D;QAEA,OAAOF,QAAQ,CAAC,IAAI,EAAE6B,MAAM,CAAC;MAC/B,CAAC,CAAC;IACJ,CAAC;IACDC,OAAO,EAAE,SAATA,OAAOA,CAAGD,MAAM,EAAK;MACnB,IAAIA,MAAM,EAAE;QACVA,MAAM,CAACd,KAAK,CAAC,CAAC;MAChB;IACF,CAAC;IACDgB,GAAG,EAAEP,OAAO,CAACO,GAAG,IAAI,EAAE;IACtBC,iBAAiB,EAAER,OAAO,CAACQ,iBAAiB,IAAI,KAAK;IACrDC,kBAAkB,EAAET,OAAO,CAACS,kBAAkB,IAAI,IAAI;IACtDC,GAAG,EAAEV,OAAO,CAACU;EACf,CAAC,CAAC;EACF;AACF","ignoreList":[]}