{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["const NativeClient = require('bindings')('addon').Client;\nconst genericPool = require('generic-pool');\n\nimport Cursor from './cursor';\n\nfunction defaultNoticeProcessor(message) {\n  console.warn(message);\n}\n\nlet nextClientID = 0;\n\nexport class Client {\n  constructor() {\n    this.nativeClient = new NativeClient();\n    this.id = ++nextClientID;\n  }\n\n  connect(string, callback) {\n    this.nativeClient.connect(string, (err) => {\n      if (err) {\n        return callback(err, this);\n      }\n\n      this.nativeClient.setNoticeProcessor(Client.defaultNoticeProcessor || defaultNoticeProcessor);\n\n      return callback(null, this);\n    });\n  }\n\n  query(sql) {\n    if (!this.nativeClient.finished()) {\n      throw new Error('client in use', this.id);\n    }\n\n    this.nativeClient.query(sql);\n\n    return new Cursor(this);\n  }\n\n  // fetch a single result record\n  getResult(returnMetadata, callback) {\n    Client.setImmediate(() => {\n      callback(this.nativeClient.getResult(returnMetadata));\n    });\n  }\n\n  getResults(returnMetadata, callback) {\n    Client.setImmediate(() => {\n      this.nativeClient.getResultsAsync(returnMetadata, (results) => {\n        callback(results);\n      });\n    });\n  }\n\n  close() {\n    return this.nativeClient.close();\n  }\n\n  setNoticeProcessor(processor) {\n    this.nativeClient.setNoticeProcessor(processor);\n  }\n\n  get lastError() {\n    const error = this.nativeClient.lastError();\n\n    if (error == null) {\n      return null;\n    }\n\n    const queryError = new Error();\n\n    for (const prop in error) {\n      if (error.hasOwnProperty(prop)) {\n        queryError[prop] = error[prop];\n      }\n    }\n\n    return queryError;\n  }\n}\n\nClient.setImmediate = setImmediate;\nClient.defaultNoticeProcessor = defaultNoticeProcessor;\n\nexport function createPool(options) {\n  /* eslint-disable new-cap */\n  return genericPool.Pool({\n    name: options.name || 'minipg',\n    create: (callback) => {\n      new Client().connect(options.db, (err, client) => {\n        if (err) {\n          return callback(client ? client.lastError : err);\n        }\n\n        return callback(null, client);\n      });\n    },\n    destroy: (client) => {\n      client.close();\n    },\n    max: options.max || 10,\n    idleTimeoutMillis: options.idleTimeoutMillis || 30000,\n    reapIntervalMillis: options.reapIntervalMillis || 1000,\n    log: options.log\n  });\n  /* eslint-enable new-cap */\n}\n"]}